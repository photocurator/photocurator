openapi: 3.0.3
info:
  title: PhotoCurator API
  description: |
    PhotoCurator 서비스의 백엔드 API 명세입니다.
    제공된 DB 스키마(ERD)를 기반으로 사진 관리, AI 분석 파이프라인, 사용자 패턴 분석 및 광고 타겟팅 기능을 포함합니다.
  version: 1.0.0
servers:
  - url: https://api.photocurator.com/v1

paths:
  # ------------------------------------------------------------------
  # [Project Management]
  # ------------------------------------------------------------------
  /projects:
    get:
      summary: 프로젝트 목록 조회
      operationId: getProjects
      responses:
        '200':
          description: 프로젝트 목록 조회 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'
    post:
      summary: 프로젝트 생성
      operationId: createProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  maxLength: 100
                description:
                  type: string
      responses:
        '201':
          description: 프로젝트 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

  # ------------------------------------------------------------------
  # [Image Core Operations]
  # ------------------------------------------------------------------
  /projects/{projectId}/images:
    get:
      summary: 이미지 목록 조회 및 필터링 (핵심 뷰)
      description: |
        프로젝트 내 이미지를 조회합니다. AI 점수(QualityScore), 유저 선택(ImageSelection), 태그(ObjectTag) 기반의 필터링을 지원합니다.
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: viewType
          in: query
          description: "조회 모드 (전체, 선택된 사진, 휴지통, 베스트 추천)"
          schema:
            type: string
            enum: [ALL, PICKED, TRASH, BEST_SHOTS]
            default: ALL
        - name: minQualityScore
          in: query
          description: "QualityScore 테이블의 점수 기반 필터링"
          schema:
            type: number
        - name: nextCursor
          in: query
          description: "페이지네이션을 위한 커서"
          schema:
            type: string
      responses:
        '200':
          description: 이미지 목록 반환 (메타데이터 및 분석 결과 포함)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ImageDetail'
                  nextCursor:
                    type: string

    post:
      summary: 이미지 업로드
      description: "이미지 파일 업로드. 업로드 즉시 'Image' 레코드가 생성되며 EXIF 추출 작업이 시작됩니다."
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        '202':
          description: 업로드 요청 수락 (처리 중)

  # ------------------------------------------------------------------
  # [User Feedback & RLHF]
  # ------------------------------------------------------------------
  /images/{imageId}/selection:
    put:
      summary: 이미지 선택/평가 업데이트
      description: "사용자의 사진 선택 여부(is_picked)와 등급(rating)을 갱신합니다."
      parameters:
        - name: imageId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                isPicked:
                  type: boolean
                rating:
                  type: integer
                  minimum: 0
                  maximum: 5
      responses:
        '200':
          description: 상태 업데이트 완료

  /images/{imageId}/reject:
    post:
      summary: 사진 삭제/숨김 및 사유 기록
      description: |
        사진을 'REJECTED' 상태로 변경하고, 'UserRejectionReason' 테이블에 사유를 기록하여 추후 개인화 모델 학습에 활용합니다.
      parameters:
        - name: imageId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reasonCode]
              properties:
                reasonCode:
                  type: string
                  enum: [BLURRY, BAD_COMPOSITION, CLOSED_EYES, DUPLICATE, OTHER]
                reasonText:
                  type: string
                  description: "기타 사유 입력 시 구체적 내용"
      responses:
        '200':
          description: 거절 사유 기록 및 상태 변경 완료

  # ------------------------------------------------------------------
  # [AI Analysis Pipeline]
  # ------------------------------------------------------------------
  /projects/{projectId}/analyze:
    post:
      summary: 비동기 AI 분석 작업 요청
      description: "프로젝트 내 미분석 이미지들에 대해 'AnalysisJob'을 생성하고 큐에 등록합니다."
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                jobType:
                  type: string
                  enum: [FULL_SCAN, OBJECT_DETECTION_ONLY, SCORING_ONLY]
                  default: FULL_SCAN
      responses:
        '202':
          description: 분석 작업 생성됨 (Accepted)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisJob'

  /projects/{projectId}/analysis/status:
    get:
      summary: 분석 진행 상황 조회
      description: "최근 생성된 AnalysisJob의 진행률(AnalysisJobItem의 완료 비율)을 반환합니다."
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 진행 상황 반환
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobId:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [PENDING, PROCESSING, COMPLETED, FAILED]
                  progressPercentage:
                    type: number
                    format: float
                  completedItems:
                    type: integer
                  totalItems:
                    type: integer

  # ------------------------------------------------------------------
  # [User Statistics & Ads]
  # ------------------------------------------------------------------
  /users/me/statistics:
    get:
      summary: 사용자 촬영 패턴 분석
      description: "'ShootingPattern' 테이블에 집계된 유저의 주 사용 카메라, 렌즈, ISO 평균 등을 반환합니다."
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShootingPattern'
  /users/me/statistics/calculate:
    post:
      summary: 사용자 촬영 패턴 분석 계산 요청
      description: "사용자의 촬영 패턴 분석을 비동기적으로 계산하도록 요청합니다."
      responses:
        '202':
          description: 계산 요청 수락됨

  /ads/banner:
    get:
      summary: 타겟 광고 요청
      description: |
        현재 컨텍스트와 유저의 'ShootingPattern'을 'AdTargetingRule'과 대조하여 가장 적합한 광고를 반환합니다.
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  adId:
                    type: string
                    format: uuid
                  imageUrl:
                    type: string
                  clickUrl:
                    type: string
                  trackingToken:
                    type: string
                    description: "AdImpression 생성을 위한 토큰"

components:
  schemas:
    Project:
      type: object
      properties:
        projectId:
          type: string
          format: uuid
        name:
          type: string
        coverImageId:
          type: string
          format: uuid
          nullable: true
        createdAt:
          type: string
          format: date-time

    ImageDetail:
      description: "Image 테이블과 관련 메타데이터, 점수, 태그를 Join한 상세 객체"
      type: object
      properties:
        imageId:
          type: string
          format: uuid
        urls:
          type: object
          properties:
            original:
              type: string
            thumbnail:
              type: string
        exif:
          $ref: '#/components/schemas/ImageEXIF'
        analysis:
          type: object
          properties:
            qualityScore:
              $ref: '#/components/schemas/QualityScore'
            bestShot:
              type: boolean
              description: "BestShotRecommendation 테이블 존재 여부"
            objectTags:
              type: array
              items:
                $ref: '#/components/schemas/ObjectTag'
        userFeedback:
          $ref: '#/components/schemas/ImageSelection'

    ImageEXIF:
      type: object
      properties:
        cameraModel:
          type: string
        lensModel:
          type: string
        iso:
          type: integer
        aperture:
          type: number
        shutterSpeed:
          type: string

    QualityScore:
      type: object
      description: "AI가 분석한 미적/기술적 점수"
      properties:
        brisqueScore:
          type: number
          description: "낮을수록 좋은 품질 (일반적 기준)"
        tenegradScore:
          type: number
          description: "선명도 척도"
        musiqScore:
          type: number
          description: "Google MUSIQ 미적 점수"

    ObjectTag:
      type: object
      properties:
        tagName:
          type: string
        confidence:
          type: number
          format: float
        boundingBox:
          type: object
          properties:
            x: {type: integer}
            y: {type: integer}
            w: {type: integer}
            h: {type: integer}

    ImageSelection:
      type: object
      description: "사용자의 상호작용 상태"
      properties:
        isPicked:
          type: boolean
        isRejected:
          type: boolean
        rating:
          type: integer

    AnalysisJob:
      type: object
      properties:
        jobId:
          type: string
          format: uuid
        jobType:
          type: string
        status:
          type: string
        startedAt:
          type: string
          format: date-time

    ShootingPattern:
      type: object
      properties:
        avgIso:
          type: number
        mostCommonFocalLength:
          type: number
        totalPhotosAnalyzed:
          type: integer
        mostUsedCameraId:
          type: string
          format: uuid
